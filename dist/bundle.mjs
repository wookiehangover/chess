const e="---",t="abcdefgh".split(""),n="87654321".split(""),o=e=>{const[t,n]=e.split("");return[t,parseInt(n,10)]},r=(e,t)=>e>t?1:-1,s=(e,t)=>e>t?e-t:t-e,i=([e,n],[o,i])=>{const c=t.indexOf(o),h=t.indexOf(e);return[[r(i,n),s(i,n)],[r(c,h),s(c,h)]]},c=e=>(e.color,e),h=e=>{!1!==e?(console.log(""),n.forEach(t=>((e,t)=>{const n=((e,t)=>{const n=t-1;return[e.a[n],e.b[n],e.c[n],e.d[n],e.e[n],e.f[n],e.g[n],e.h[n]]})(e,t).map(c).join(" ");console.log(`${t}: ${n}`)})(e,t)),console.log(`   ${t.join("   ")}\n`),(e=>{const t=e.pieces.reduce((e,t)=>(e[t.color].push(t.toChar()),e),{black:[],white:[]});t.black.sort().join(" "),t.white.sort().join(" ")})(e),console.log("")):console.log("Invalid Board!")};class l{constructor(n=[]){t.forEach(t=>{this[t]=new Array(8).fill(e,0,8)}),n.forEach(e=>{const[t,n]=e.coords;this[t].splice(n-1,1,e)})}get pieces(){return t.map(e=>this[e]).reduce((t,n)=>(t.push.apply(t,n.filter(t=>t!==e)),t),[])}write(e,t){const[n,o]=e;this[n].splice(o-1,1,t)}forEach(e){t.forEach(t=>{n.forEach(n=>{e.call(this,t+n,this.getPiece(t+n))})})}map(e){const t=[];return this.forEach((n,o)=>{t.push(e(n,o))}),t}getPiece(e){return u(this,e)}walk(e,t){return p(this,e,t)}walkDiagonal(e,t){return d(this,e,t)}}const a=e=>new l(e),u=(e,t)=>{const[n,r]=o(t),s=e[n][r-1];return!!(s&&s.color&&s.name)&&s},f=(e,t,n)=>{const o=u(e,t);return!1!==o&&(!0!==o.move(e,n)?(console.log(`${t}->${n} isn't a valid move!`),!1):(console.log(`${o.color}: ${t} -> ${n}`),e))},p=(e,[n,o],[r,s])=>{let c=!0;const[[h,l],[a,f]]=i([n,o],[r,s]),p=f+l,d=t.indexOf(n);for(let n=1;n<p;n++){const r=o+h*n*Math.min(l,1),s=t[d+a*n*Math.min(f,1)];if(u(e,s+r)){c=!1;break}}return c},d=(e,[n,o],[r,s])=>{let c=!0;const[[h,l],[a,f]]=i([n,o],[r,s]);if(f>0&&l>0){const r=t.indexOf(n);for(let n=1,s=1;n<l&&s<f;n++,s++){const i=o+h*n,l=t[r+a*s];if(u(e,l+i)){c=!1;break}}}return c};function v(){}function w(){w.init.call(this)}function m(e){return void 0===e._maxListeners?w.defaultMaxListeners:e._maxListeners}function g(e,t,n,o){var r,s,i,c;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),i=s[t]):(s=e._events=new v,e._eventsCount=0),i){if("function"==typeof i?i=s[t]=o?[n,i]:[i,n]:o?i.unshift(n):i.push(n),!i.warned&&(r=m(e))&&r>0&&i.length>r){i.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=i.length,c=h,"function"==typeof console.warn?console.warn(c):console.log(c)}}else i=s[t]=n,++e._eventsCount;return e}function b(e,t,n){var o=!1;function r(){e.removeListener(t,r),o||(o=!0,n.apply(e,arguments))}return r.listener=n,r}function y(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function x(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}v.prototype=Object.create(null),w.EventEmitter=w,w.usingDomains=!1,w.prototype.domain=void 0,w.prototype._events=void 0,w.prototype._maxListeners=void 0,w.defaultMaxListeners=10,w.init=function(){this.domain=null,w.usingDomains&&(void 0).active&&(void 0).Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new v,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},w.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},w.prototype.getMaxListeners=function(){return m(this)},w.prototype.emit=function(e){var t,n,o,r,s,i,c,h="error"===e;if(i=this._events)h=h&&null==i.error;else if(!h)return!1;if(c=this.domain,h){if(t=arguments[1],!c){if(t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=c,t.domainThrown=!1,c.emit("error",t),!1}if(!(n=i[e]))return!1;var a="function"==typeof n;switch(o=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var o=e.length,r=x(e,o),s=0;s<o;++s)r[s].call(n)}(n,a,this);break;case 2:!function(e,t,n,o){if(t)e.call(n,o);else for(var r=e.length,s=x(e,r),i=0;i<r;++i)s[i].call(n,o)}(n,a,this,arguments[1]);break;case 3:!function(e,t,n,o,r){if(t)e.call(n,o,r);else for(var s=e.length,i=x(e,s),c=0;c<s;++c)i[c].call(n,o,r)}(n,a,this,arguments[1],arguments[2]);break;case 4:!function(e,t,n,o,r,s){if(t)e.call(n,o,r,s);else for(var i=e.length,c=x(e,i),h=0;h<i;++h)c[h].call(n,o,r,s)}(n,a,this,arguments[1],arguments[2],arguments[3]);break;default:for(r=new Array(o-1),s=1;s<o;s++)r[s-1]=arguments[s];!function(e,t,n,o){if(t)e.apply(n,o);else for(var r=e.length,s=x(e,r),i=0;i<r;++i)s[i].apply(n,o)}(n,a,this,r)}return!0},w.prototype.addListener=function(e,t){return g(this,e,t,!1)},w.prototype.on=w.prototype.addListener,w.prototype.prependListener=function(e,t){return g(this,e,t,!0)},w.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,b(this,e,t)),this},w.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,b(this,e,t)),this},w.prototype.removeListener=function(e,t){var n,o,r,s,i;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(o=this._events))return this;if(!(n=o[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new v:(delete o[e],o.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,s=n.length;s-- >0;)if(n[s]===t||n[s].listener&&n[s].listener===t){i=n[s].listener,r=s;break}if(r<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new v,this;delete o[e]}else!function(e,t){for(var n=t,o=n+1,r=e.length;o<r;n+=1,o+=1)e[n]=e[o];e.pop()}(n,r);o.removeListener&&this.emit("removeListener",e,i||t)}return this},w.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new v,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new v:delete n[e]),this;if(0===arguments.length){for(var o,r=Object.keys(n),s=0;s<r.length;++s)"removeListener"!==(o=r[s])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=new v,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},w.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},w.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):y.call(e,t)},w.prototype.listenerCount=y,w.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class _{constructor(e,t){this.color=e,this.position=t}capture(e){console.log(`${this.color}: ${this.toChar()} ${this.position} takes ${e.toChar()} ${e.position}!`)}get coords(){return o(this.position)}get name(){return this.constructor.name.substr(0,1)}get fullName(){return this.constructor.name}validMoves(e){const t=[];return e.forEach(n=>{this.move(e,n)&&t.push(n)}),t}toString(){return this.name+this.position}move(e,t){throw new Error("Not implemented!")}clone(){return new this.constructor(this.color,this.position)}}class L extends _{move(n,r){const s=o(r),[i,c]=this.coords,[h,l]=s,a=n[h][l-1]!==e;let u=!1;const f="white"===this.color?1:-1,p=c+f,d=p===l;if(a){const e=t.indexOf(h),n=t.indexOf(i),o=e===n-1||e===n+1;d&&o&&(u=!0)}else{const e=i===h;d&&e&&(u=!0);const t=p+f===l&&e;"white"===this.color&&t&&2===c&&(u=!0),"black"===this.color&&t&&7===c&&(u=!0),u&&(u=n.walk(this.coords,s))}const v=n.getPiece(r);return!1!==v&&u&&this.capture(v),u}toString(){return" "+this.position}toChar(){return"white"===this.color?"♙":"♟"}}class k extends _{move(e,t){const n=o(t),[r,s]=this.coords,[i,c]=n;let h=!1;if(s!==c&&r!==i||(h=!0),h){h=e.walk(this.coords,n);const o=e.getPiece(t);!1!==o&&h&&(o.color===this.color?h=!1:(h=!0,this.capture(o)))}return h}toChar(){return"white"===this.color?"♖":"♜"}}const M=e=>Math.abs(e[0]*e[1]);class E extends _{move(e,t){const n=o(t);let r=!1;const[s,c]=i(this.coords,n),h=M(c),l=M(s);(1===h&&2===l||2===h&&1===l)&&(r=!0);const a=e.getPiece(t);return!1!==a&&r&&(a.color===this.color?r=!1:(r=!0,this.capture(a))),r}get fullName(){return"Knight"}toChar(){return"white"===this.color?"♘":"♞"}}class C extends _{move(e,n){const r=o(n),[s,i]=this.coords,[c,h]=r,l=t.indexOf(c),a=t.indexOf(s);let u=!1;if(Math.abs(l-a)===Math.abs(h-i)&&(u=!0),u){u=e.walkDiagonal(this.coords,r);const t=e.getPiece(n);!1!==t&&u&&(t.color===this.color?u=!1:(u=!0,this.capture(t)))}return u}toChar(){return"white"===this.color?"♗":"♝"}}class O extends _{move(e,n){const r=o(n),[s,c]=this.coords,[h,l]=r,a=t.indexOf(h),u=t.indexOf(s);let f=!1;if(c!==l&&s!==h||(f=!0),Math.abs(a-u)===Math.abs(l-c)&&(f=!0),f){const[t,o]=i(this.coords,r),s=t[1];f=o[1]>0&&s>0?e.walkDiagonal(this.coords,r):e.walk(this.coords,r);const c=e.getPiece(n);!1!==c&&f&&(c.color===this.color?f=!1:(f=!0,this.capture(c)))}return f}toChar(){return"white"===this.color?"♕":"♛"}}const P=e=>Math.abs(e[0]*e[1]);class $ extends _{move(e,t){const n=o(t);let r=!1;const[s,c]=i(this.coords,n),h=P(c);P(s)<=1&&h<=1&&(r=!0);const l=e.getPiece(t);return!1!==l&&r&&(l.color===this.color?r=!1:(r=!0,this.capture(l))),r}toChar(){return"white"===this.color?"♔":"♚"}}const j={...Object.freeze({Pawn:L,wP:(...e)=>new L("white",...e),bP:(...e)=>new L("black",...e)}),...Object.freeze({Rook:k,wR:(...e)=>new k("white",...e),bR:(...e)=>new k("black",...e)}),...Object.freeze({Night:E,wN:(...e)=>new E("white",...e),bN:(...e)=>new E("black",...e)}),...Object.freeze({Bishop:C,wB:(...e)=>new C("white",...e),bB:(...e)=>new C("black",...e)}),...Object.freeze({Queen:O,wQ:(...e)=>new O("white",...e),bQ:(...e)=>new O("black",...e)}),...Object.freeze({King:$,wK:(...e)=>new $("white",...e),bK:(...e)=>new $("black",...e)})},{wP:N,bP:A,wR:K,bR:z,wN:B,bN:D,wB:R,bB:T,wQ:Q,bQ:S,wK:I,bK:U}=j,V=[z("a8"),D("b8"),T("c8"),S("d8"),U("e8"),T("f8"),D("g8"),z("h8"),A("a7"),A("b7"),A("c7"),A("d7"),A("e7"),A("f7"),A("g7"),A("h7"),N("a2"),N("b2"),N("c2"),N("d2"),N("e2"),N("f2"),N("g2"),N("h2"),K("a1"),B("b1"),R("c1"),Q("d1"),I("e1"),R("f1"),B("g1"),K("h1")];let W=new class extends w{constructor(e=V){super(),this.history=[],this.pieces=e,this.board=a(e),this.on("move",h),h(this.board)}get lastMove(){return this.history[this.history.length-1]}get nextMove(){return 0===this.history.length?"white":"white"===this.board.getPiece(this.lastMove[2]).color?"black":"white"}update(e,t){this.history.push([this.pieces.map(e=>e.clone()),e,t])}move(t,n){const r=u(this.board,t);let s=f(this.board,t,n);if(r.color!==this.nextMove&&(s=!1,console.log(`Slow down there. It's ${this.nextMove}'s turn.`)),!1!==s){const i=u(this.board,n);this.update(t,n),s.write(r.coords,e),s.write(o(n),r),r.position=n,this.emit("move",s),i&&this.emit("capture",i)}return this.board}};W.move("e2","e4");const q="87654321".split("").map(e=>"abcdefgh".split("").map(t=>`${t}${e}`)).reduce((e,t)=>(e.push.apply(e,t),e),[]),F=e=>q.reduce((t,n)=>(t[n]=e.getPiece(n),t),{}),G=new Vue({el:"#board",data:{selected:null,validMoves:[],board:F(W.board)},methods:{selectPiece(e){const t=W.board.getPiece(e);this.selected&&e?(W.move(this.selected,e),this.selected=null,this.validMoves=[]):e&&t.color===W.nextMove&&(this.selected=e,this.validMoves=t.validMoves(W.board))},isSelected(e){return{selected:e===this.selected}},isValid(e){return{[e]:!0,valid:this.validMoves.includes(e)}}}});window.app=G,window.game=W,W.on("move",()=>{G.board=F(W.board)});
